---
title: "Risk set" 
author: ""
package: remify
date: ""
output: 
  rmarkdown::html_document:
    theme: bootstrap
    css: "remify-theme.css"
header-includes:
   - \usepackage{tikz}
   - \usepackage{pgfplots}
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Define a dynamic riskset}
  %\VignetteEncoding{UTF-8}
---

<i> This vignette provides a definition of static and dynamic risk set, explains how a dynamic risk set is supplied to the processing function `remify::reh()`, and it shows how the risk set looks like in the processed `reh` object. </i>

For this vignette we are going to consider the random relational event history (`randomREH`) processed with `remify::reh()`.
```{r}
library(remify)

# random REH
data(randomREH) 

# processing the edgelist 
edgelist_reh <- reh(edgelist = randomREH$edgelist,
                    actors = randomREH$actors,
                    types = randomREH$types, 
                    directed = TRUE, # events are directed
                    ordinal = FALSE, # model with waiting times
                    origin = randomREH$origin,
                    omit_dyad = randomREH$omit_dyad,
                    model = "tie") # tie-oriented modeling            
```
---

# {.tabset .tabset-fade .tabset-pills .tabcontent} 


## What is a risk set?

In a relational event history, we observe a time-ordered sequence of interactions occurring among actors and, for each relational event, we know its time (or the order) of occurrence along with which actors were involved in the interaction and the type of the interaction (if measured). For instance, the table below shows the first five events of the random relational event history, where `time`, `actor1`, `actor2` and `type` describe each observed event in the sequence

```{r, include = TRUE}
randomREH$edgelist[1:5,]
```

When modeling a relational event sequence, we need to specify a risk set for each observed time point. A risk set consists of the ensemble of those relational events that are likely to be observed in the network at a specific time point, and it incudes also the event that is observed at that particular time point.

<marquee>[[add image here explaining what the risk set is]]</marquee>

In the following sections, we first discuss a common definition of the risk set that doesn't change composition over time, the _static_ risk set, and explain how the processing function (`remify::reh()`) orders the events in the risk set. Then we discuss the _dynamic_ risk set where some events are excluded from the risk set during specific time windows and we present some examples of scenarios in which this specification of risk set finds application. Finally, we provide a simple visualisation of the dynamic risk set on the timeline of the observed event sequence.

### A time-invariant risk set
Generally, the compostion of the risk set is assumed to be the same over time (_static_ risk set), which means that for the whole period of study the risk set is made of the same set of dyads. If the network has _N_ actors and it consists of directed events that can assume a number of _C_ possible event types, then the risk set will be characterized by all the possible directed dyads among _N_ actors, that are _D = N(N-1)C_, or _D = N(N-1)C/2_ in the case of undirected dyads. For instance, in the random network (`randomREH`) dyads are directed, actors are _N = 20_ and event types are _C = 3_, therefore we expect the dimension of the risk set to be _D = 20 * 19 * 3 = 1140_. The first five dyads in the static riskset will be

```{r, include = TRUE}
dyad(reh = edgelist_reh, dyadID = c(1:5)) # method dyad.reh(), see more in ?remify::dyad
```

The ID of the dyads (`dyadID`) is also the order of the dyads used by the functions in <a href='https://github.com/TilburgNetworkGroup/'>`remverse`</a> and it is defined by a two-steps approach:

1. Actors' and types' names are first sorted according to their <div class="hovertip">
 alphanumeric<span class="hovertiptext"><p>The alphanumeric order first follows the order of numbers from 0 to 9, then the alphabetical order of the letters.</p> <p>For instance, given the vector of names `c("user22","0usr","1user","1deer")`, its alphanumeric order will be `c("0usr","1deer","1user","user22)`</p><i></i></span></div> order, that for the random network is
```{r, include = TRUE}
sorted_actors <- sort(randomREH$actors) # sorted vector of actors' names
N <- length(randomREH$actors)
```
```{r, include = TRUE}
sorted_types <- sort(randomREH$types) # sorted vector of types' names
C <- length(randomREH$types)
```

2. dyads are defined by the triple `c(actor1,actor2,type)` that is found by looping first on `actor2`, then `actor1`, and finally `type`. An example of the loops is shown below
```{r, include = TRUE}
dyad <- matrix(NA, nrow = N*(N-1)*C, ncol = 3)
colnames(dyad) <- c("actor1","actor2","type")
rownames(dyad) <- 1:(N*(N-1)*C)
d <- 1 # position index
for(type in sorted_types){ # loop over event types
  for(actor1 in sorted_actors){ # loop over actor1
    for(actor2 in sorted_actors){ # loop over actor2
      if(actor1!=actor2){ # avoid self-loops
        dyad[d,] <- c(actor1,actor2,type)
        d <- d + 1
      }
    }
  }
}

dyad[1:5,] # same result as showed above by using the method `dyad()`
dim(dyad)[1] # checking the size of the static risk set that is 1140
```
The matrix `dyad` above describes the static risk set and the row indces correspond to the ID of the dyad (`dyadID`). For instance, `dyadID` is used in the output of the processed edgelist, under the column named `"dyad"`

```{r, include = TRUE}
head(edgelist_reh$edgelist)
```


### A risk set changing composition over time

A static risk set assumes that all the possible dyads are always at risk regardless any consideration about the actual possibility of one or more actors to still be able to interact with the other actors.

However, there are circumstances in which one or more actors cannot physically take part in interactions and this can happen either temporarily or since a starting time point until the end of the study. For instance, when the relational event network is about in-person interactions (for instance at the university or at school) and it is measured over days (or even weeks or months), one or more actors may not be present during one or more days, thus we want to exclude such actors from the risk set for the time window in which they are not present. Another example is when a relational event network is observed at a conference where multiple sessions or workshops can occur at the same time. In this case, the set of dyads at risk splits down to smaller different risk sets each one based on the groups of actors participating at a specific session or workshop.
If the relational event network is about digital forms of interactions, for instance, one or more actors cannot interact one another because they do not appear in each other's friends list.
In such scenarios, a static risk set would account for relational events that are not feasible which may even lead to biased estimates of the model parameters. It is possible to account for changes of the risk set over time by defining a dynamic risk set.

A dynamic risk set consists of a time-varying ensemble of dyads at risk that is based on reasoned considerations about the study (as in the examples above). If actor "A" is not present during one day, it is then excluded from the risk set as both sender and receiver on that day. Thus, the excluded events will be all the directed events "A->X" and "X->A" with "X" being any actor that can interact at that time point.
If actor "A" is not in the study anymore, it is then excluded as possible sender and receiver of future interactions after the last day in which it was present. Note that such considerations on excuding dyads from the risk set strongly depend on the study, on its design and they should be well motivated. For instance, if actor "A" is not present one day, but the study also records the network of digital interactions between actors, it makes sense to exclude the actor "A" from the network of in-person events but not from the network of digital interactions (unless more information is provided on actor "A", for instance being also offline on the digital platform). Several other examples on dynamic risk sets can be introduced but we limit our discussion to those presented above on actor "A".

In order to provide a visual example of a dynamic risk set, consider the network of events below. The sequence is represented along the time line from left (first events) to right (last events).

```{r, echo=FALSE, engine='tikz', out.width='100%', fig.ext='png'}
\usetikzlibrary{shapes,decorations,arrows,calc,arrows.meta,fit,positioning,decorations.pathreplacing,decorations.pathmorphing}
\tikzset{
    -Latex,auto,node distance =1 cm and 1 cm,semithick,
    state/.style ={ellipse, draw, minimum width = 0.7 cm},
    point/.style = {circle, draw, inner sep=0.04cm,fill,node contents={}},
    bidirected/.style={Latex-Latex,dashed},
    el/.style = {inner sep=2pt, align=left, sloped}
}
\begin{tikzpicture}
            \draw[<-,densely dashed] (-7.4,1.6) -- (-7.4,0.55) node[below]{};
            \draw[<-,densely dashed] (-2.5,1.6) -- (-2.5,0.55) node[below]{};
            \draw[<-,densely dashed] (3.74,1.6) -- (3.74,0.55) node[below]{};
            \draw[<-,densely dashed] (6,1.6) -- (6,0.55) node[below]{};
            \draw[->,semithick] (-7.4,0) -- (7,0); 
            \draw [-,decorate,decoration={brace,amplitude=10pt},yshift=5pt] (-7.4,0.5) -- (-2.5,0.5) node [black,midway]{};
            \draw [-,decorate,decoration={brace,amplitude=10pt},yshift=5pt] (-2.5,0.5) -- (3.74,0.5) node [black,midway]{};
            \draw [-,decorate,decoration={brace,amplitude=10pt},yshift=5pt] (3.74,0.5) -- (6,0.5) node [black,midway]{};
            \draw [-,decorate,decoration={brace,amplitude=10pt},yshift=-30pt] (6,0.4) -- (-7.4,0.4) node [black,midway,yshift=-10pt,scale=0.70]{$E_{t_{14}}$};
            \foreach \x/\a in {-7/1,-6.2/2,-5/3,-4/4,-3.2/5,-2.1/6,-1.3/7,-0.2/8,0.8/9,2/10,2.9/11,4/12,4.8/13,6/14,6.6/15}
            \draw[-,semithick] (\x,0.1) -- (\x,-0.1) node[below]{\small$t_{\a}$};
            \node[scale=0.70] (x) at (-7,0.45) {$(i,j)$};
            \node[text=gray,scale=0.70] (x) at (-6.2,0.45) {$(j,i)$};
            \node[text=gray,scale=0.70] (x) at (-5,0.45) {$(l,j)$};
            \node[scale=0.70] (x) at (-4,0.45) {$(i,j)$};
            \node[text=gray,scale=0.70] (x) at (-3.2,0.45) {$(i,l)$};
            \node[text=gray,scale=0.70] (x) at (-2.1,0.45) {$(j,i)$};
            \node[scale=0.70] (x) at (-1.3,0.45) {$(i,j)$};
            \node[text=gray,scale=0.70] (x) at (-0.2,0.45) {$(j,i)$};
            \node[scale=0.70] (x) at (0.8,0.45) {$(i,j)$};
            \node[text=gray,scale=0.70] (x) at (2,0.45) {$(j,l)$};
            \node[scale=0.70] (x) at (2.9,0.45) {$(i,j)$};
            \node[text=gray,scale=0.70] (x) at (4,0.45) {$(l,j)$};
            \node[text=gray,scale=0.70] (x) at (4.8,0.45) {$(j,i)$};
            \node[scale=0.70] (x) at (6,0.45) {$(i,j)$};
            \node[scale=0.70] (x) at (-4.95,1.3) {$E_{t_{14},3}$};
            \node[scale=0.70] (x) at (0.62,1.3) {$E_{t_{14},2}$};
            \node[scale=0.70] (x) at (4.92,1.3) {$E_{t_{14},1}$};
            \node[scale=0.70] (x) at (6,1.75) {$0secs$};
            \node[scale=0.70] (x) at (3.74,1.75) {$30mins$};
            \node[scale=0.70] (x) at (-2.5,1.75) {$2hrs$};
            \node[scale=0.70] (x) at (-7.4,1.75) {$\infty$};
\end{tikzpicture} 
```




Each time point corresponds to the time of occurrence of a relational events and the occurred event is the

A dynamic risk set can be defined for both directed and undirected networks


 - examples: actors leaving the study for several reasons or just unable to interact (I do not have your phone number so I can't interact with you if not only in person when we are at the university)
 - what a dinamy risk set implies in the model likelihood (events are excluded from the risk set) 
 - figure giving an example with dyads taken out from the risk set

## Specify a dynamic risk set in reh()

 - _remify::reh_ has an input argument (<i>omit_dyad</i>) that allows the user to define a dynamic riskset and remove specific dyads from one or more time points
 - explain the input omit_dyad, its structure and example from the _randomREH_ data 
 - plot a figure where the intervals specified via <i>omit_dyad</i> are plotted one over the other

#### <b><tt>omit_dyad</tt></b>
This argument is useful when certain dyads must be removed from the risk set in specific time windows (e.g. an actor drops out of the network, specific groups of actors cannot interact anymore starting from some time point). Therefore, the processing of such information makes the risk set suit better to the real data.
`omit_dyad` consists of a list of lists. Each list refers to one risk set modification and must have two objects: a `data.frame` called `dyad`, where dyads to be remove are specified by row in the format `actor1, actor2, type`, and `time` which is a vector of two values defining the first and last time point of the time window in which such dyads couldn't occur.
Consider the example on the `randomREH` data. For instance, we want to modify (shrink) the risk set according to two changes that apply on different time intervals:


```{r}
library(remify) # loading library
data(randomREH) # loading data
```


1. an event type `conflict` that was no more feasible since a specific time point until the end of the observation period.

```{r}
randomREH$omit_dyad[[1]]$time # start and stop time point defining the time window of interest
```
```{r}
randomREH$omit_dyad[[1]]$dyad # dyads to be removed from the time points defined by the interval in `time`
```

2. two actors `Michaela` and `Zackary` that couldn't interact with anybody else after a specific time point until the last observed time point.


```{r}
randomREH$omit_dyad[[2]]$time # start and stop time point defining the time window of interest
```
```{r}
randomREH$omit_dyad[[2]]$dyad # dyads to be removed from the time points defined by the interval in `time`
```


The object `dyad` will give instructions such that the function will remove from the risk set at the indicated time windows all the events where: (1) type is `conflict`, (2) `Michaela` and ``Zackary` are senders or receivers.

The `<NA>` values mean that all the actors/types are considered in that field. Indeed, in the first change where we needed to remove all the events where `conflict` was the type, we did it by leaving both `actor1` and `actor2` unspecified `<NA>`. 
Therefore, every time one field among (`actor1`,`actor2`,`type`) is left undefined, the omission from the risk set applies to all the possible values of that field.

------

## The processed risk set

- after processing the relational event history, also the input <i>omit_dyad</i> is processed and has a different shape
- plot a figure with the processed dynamic risk set, point out the structure of the output.